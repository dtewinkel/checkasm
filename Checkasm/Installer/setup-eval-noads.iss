; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

[Setup]
; NOTE: The value of AppId uniquely identifies this application.
; Do not use the same AppId value in installers for other applications.
; (To generate a new GUID, click Tools | Generate GUID inside the IDE.)
AppId={{C28F698A-CEB3-45D3-AE4B-3065C34677DB}
AppName=CheckAsm
AppVersion=1.27.5537
;AppVerName=CheckAsm 1.7.3899
AppPublisher=amberfish.net
AppPublisherURL=http://www.amberfish.net
AppSupportURL=http://www.amberfish.net
AppUpdatesURL=http://www.amberfish.net
DefaultDirName={pf}\CheckAsm
DefaultGroupName=CheckAsm
AllowNoIcons=yes
OutputDir=.
OutputBaseFilename=setup-eval-noads
SetupIconFile=..\checkasm.ico
Compression=lzma
SolidCompression=yes

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 0,6.1

[Files]
Source: "..\bin\Release-Eval\CheckAsm.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "..\bin\Release-Eval\CheckAsm.pdb"; DestDir: "{app}"; Flags: ignoreversion
Source: "..\bin\Release-Eval\CheckAsm.exe.config"; DestDir: "{app}"; Flags: ignoreversion
Source: "..\bin\Release-Eval\CheckAsm.XmlSerializers.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "..\common\win32support.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "..\bin\Release-Eval\Amberfish.Canvas.dll"; DestDir: "{app}"; Flags: ignoreversion
; NOTE: Don't use "Flags: ignoreversion" on any shared system files

[Registry]
Root: HKLM32; Subkey: "Software\amberfishnet"; Flags: uninsdeletekeyifempty;
Root: HKLM32; Subkey: "Software\amberfishnet\checkasm"; Flags: uninsdeletekeyifempty
Root: HKLM32; Subkey: "Software\amberfishnet\checkasm"; ValueType: string; ValueName: "install"; ValueData: "{code:DateTime}"; Flags:createvalueifdoesntexist
Root: HKLM64; Subkey: "Software\amberfishnet"; Flags: uninsdeletekeyifempty; Check: IsWin64
Root: HKLM64; Subkey: "Software\amberfishnet\checkasm"; Flags: uninsdeletekeyifempty; Check: IsWin64
Root: HKLM64; Subkey: "Software\amberfishnet\checkasm"; ValueType: string; ValueName: "install"; ValueData: "{code:DateTime}"; Check: IsWin64; Flags:createvalueifdoesntexist

[Icons]
Name: "{group}\CheckAsm"; Filename: "{app}\CheckAsm.exe"
Name: "{group}\{cm:ProgramOnTheWeb,CheckAsm}"; Filename: "http://www.amberfish.net"
Name: "{commondesktop}\CheckAsm"; Filename: "{app}\CheckAsm.exe"; Tasks: desktopicon
Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\CheckAsm"; Filename: "{app}\CheckAsm.exe"; Tasks: quicklaunchicon
; Add uninstall icon entry on program menu:
Name: "{group}\Uninstall CheckAsm"; Filename: "{uninstallexe}"

[CustomMessages]
english.dotnetmissing = This setup requires the .NET Framework 4. Please download and install the .NET Framework 4 and run this setup again. Do you want to download the framework now?

[Code]

function DateTime(param:string) : String;
begin
  result := GetDateTimeString('mm/dd/yyyy','-',':');
end;

function InitializeSetup(): Boolean;
var
    ErrorCode: Integer;
    NetFrameWorkInstalled : Boolean;
    Result1 : Boolean;
begin
	NetFrameWorkInstalled := RegKeyExists(HKLM,'SOFTWARE\Microsoft\.NETFramework\policy\v4.0');
	if NetFrameWorkInstalled =true then
	begin
		Result := true;
	end;

	if NetFrameWorkInstalled = false then
	begin
		NetFrameWorkInstalled := RegKeyExists(HKLM,'SOFTWARE\Microsoft\.NETFramework\policy\v4.0');
		if NetFrameWorkInstalled =true then
		begin
			Result := true;
		end;

		if NetFrameWorkInstalled =false then
			begin
				//Result1 := (ExpandConstant('{cm:dotnetmissing}'), mbConfirmation, MB_YESNO) = idYes;
				Result1 := MsgBox(ExpandConstant('{cm:dotnetmissing}'),
						mbConfirmation, MB_YESNO) = idYes;
				if Result1 =false then
				begin
					Result:=false;
				end
				else
				begin
					Result:=false;
					ShellExec('open',
					'http://download.microsoft.com/download/1/B/E/1BE39E79-7E39-46A3-96FF-047F95396215/dotNetFx40_Full_setup.exe',
					'','',SW_SHOWNORMAL,ewNoWait,ErrorCode);
                end;
            end;
	end;
end;
